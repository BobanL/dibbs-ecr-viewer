<!DOCTYPE html><html class="default" lang="en" data-base="./"><head><meta charset="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>ecr-viewer</title><meta name="description" content="Documentation for ecr-viewer"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="assets/style.css"/><link rel="stylesheet" href="assets/highlight.css"/><script defer src="assets/main.js"></script><script async src="assets/icons.js" id="tsd-icons-script"></script><script async src="assets/search.js" id="tsd-search-script"></script><script async src="assets/navigation.js" id="tsd-nav-script"></script><script async src="assets/hierarchy.js" id="tsd-hierarchy-script"></script></head><body><script>document.documentElement.dataset.theme = localStorage.getItem("tsd-theme") || "os";document.body.style.display="none";setTimeout(() => window.app?app.showPage():document.body.style.removeProperty("display"),500)</script><header class="tsd-page-toolbar"><div class="tsd-toolbar-contents container"><a href="index.html" class="title">ecr-viewer</a><div id="tsd-toolbar-links"></div><button id="tsd-search-trigger" class="tsd-widget" aria-label="Search"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="assets/icons.svg#icon-search"></use></svg></button><dialog id="tsd-search" aria-label="Search"><input role="combobox" id="tsd-search-input" aria-controls="tsd-search-results" aria-autocomplete="list" aria-expanded="true" autocapitalize="off" autocomplete="off" placeholder="Search the docs" maxLength="100"/><ul role="listbox" id="tsd-search-results"></ul><div id="tsd-search-status" aria-live="polite" aria-atomic="true"><div>Preparing search index...</div></div></dialog><a href="#" class="tsd-widget menu" id="tsd-toolbar-menu-trigger" data-toggle="menu" aria-label="Menu"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="assets/icons.svg#icon-menu"></use></svg></a></div></header><div class="container container-main"><div class="col-content"><div class="tsd-page-title"><h1>ecr-viewer</h1></div><div class="tsd-panel tsd-typography"><h1 id="getting-started-with-dibbs-ecr-viewer" class="tsd-anchor-link">Getting Started with DIBBs eCR Viewer<a href="#getting-started-with-dibbs-ecr-viewer" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h1><h2 id="introduction" class="tsd-anchor-link">Introduction<a href="#introduction" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2><p>The DIBBs eCR Viewer service offers a REST API for processing eCR FHIR messages into an HTML page that displays key information in a readable format and makes specific data fields easy to find.</p>
<h2 id="running-ecr-viewer" class="tsd-anchor-link">Running eCR Viewer<a href="#running-ecr-viewer" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2><p>You can run the eCR Viewer using Docker, any other OCI container runtime (e.g., Podman), or directly from the source code.</p>
<h3 id="running-with-docker-recommended" class="tsd-anchor-link">Running with Docker (Recommended)<a href="#running-with-docker-recommended" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><p>To run the eCR Viewer with Docker, follow these steps.</p>
<ol>
<li>Confirm that you have Docker installed by running <code>docker -v</code>. If you don't see a response similar to what's shown below, follow <a href="https://docs.docker.com/get-docker/">these instructions</a> to install Docker.</li>
</ol>
<pre><code><span class="hl-0">‚ùØ </span><span class="hl-1">docker</span><span class="hl-0"> -</span><span class="hl-1">v</span><br/><span class="hl-1">Docker</span><span class="hl-0"> </span><span class="hl-1">version</span><span class="hl-0"> </span><span class="hl-2">20.10</span><span class="hl-0">.</span><span class="hl-2">21</span><span class="hl-0">, </span><span class="hl-1">build</span><span class="hl-0"> </span><span class="hl-1">baeda1f</span>
</code><button>Copy</button></pre>

<ol start="2">
<li>Download a copy of the Docker image from the PHDI repository by running <code>docker pull ghcr.io/cdcgov/dibbs-ecr-viewer/ecr-viewer:latest</code>.</li>
<li>Run the service with <code>docker run -p 8080:8080 ecr-viewer:latest</code>.</li>
</ol>
<p>Congratulations, the eCR Viewer should now be running on <code>localhost:8080</code>!</p>
<h3 id="running-from-nodejs-source-code" class="tsd-anchor-link">Running from Node.js Source Code<a href="#running-from-nodejs-source-code" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><p>We recommend running the eCR Viewer from a container, but if that isn't feasible for a given use-case, please see the <a href="##Development">Development section</a> for instruction to run the eCR Viewer locally</p>
<h2 id="building-the-docker-image" class="tsd-anchor-link">Building the Docker Image<a href="#building-the-docker-image" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2><p>To build the Docker image for the eCR Viewer from source instead of downloading it from the PHDI repository follow these steps.</p>
<ol>
<li>Ensure that both <a href="https://git-scm.com/book/en/v2/Getting-Started-Installing-Git">Git</a> and <a href="https://docs.docker.com/get-docker/">Docker</a> are installed.</li>
<li>Clone the PHDI repository with <code>git clone https://github.com/CDCgov/dibbs-ecr-viewer</code>.</li>
<li>Navigate to <code>/dibbs-ecr-viewer/containers/ecr-viewer/</code>.</li>
<li>Run <code>docker build -t ecr-viewer .</code>.</li>
</ol>
<h2 id="non-integrated-viewer" class="tsd-anchor-link">Non Integrated Viewer<a href="#non-integrated-viewer" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2><p>To enable the Non Integrated Viewer homepage, set the environment variable <code>CONFIG_NAME</code> equal to <code>AWS_PG_NON_INTEGRATED</code>, <code>AWS_SQLSERVER_NON_INTEGRATED</code>,<code>AZURE_PG_NON_INTEGRATED</code>, or <code>AZURE_SQLSERVER_NON_INTEGRATED</code> . This will enable the Non Integrated viewer homepage at <code>localhost:3000/ecr-viewer</code>.</p>
<h2 id="potential-issues" class="tsd-anchor-link">Potential Issues<a href="#potential-issues" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2><p>If you have problems connecting to your database, use this command to see what other postgres databases might be running
<code>sudo lsof -i :5432</code>. If anything is using that port, kill it using: <code>kill {pid}</code></p>
<p>If building the Docker Image doesn't work as expected, try to first run the eCR Viewer locally using the steps below.</p>
<p>If you consistently encounter the error message <code>&quot;ecr_viewer_db&quot; does not exist</code> when attempting to run the app, there could be conflicting databases running on port 5432 as part of other background processes. Try pruning any dangling Docker images and containers (<code>docker image prune</code> and <code>docker container prune</code>). If issues persist, try logging into <code>psql</code> on the command line to see what databases are running there.</p>
<h2 id="development" class="tsd-anchor-link">Development<a href="#development" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2><h3 id="run-ecr-viewer-locally" class="tsd-anchor-link">Run eCR Viewer Locally<a href="#run-ecr-viewer-locally" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><p>To run the eCR Viewer locally:</p>
<ol>
<li>Ensure that Git, Docker, and Node (version 18.x or higher) are installed.</li>
<li>Clone the PHDI repository with <code>git clone https://github.com/CDCgov/dibbs-ecr-viewer</code>.</li>
<li>Navigate to <code>/dibbs-ecr-viewer/containers/ecr-viewer/</code>.</li>
<li>Install all of the Node dependencies for the eCR Viewer with <code>npm install</code>.</li>
<li>Setup your <code>.env.local</code> by running <code>npm run setup-local-env</code>.</li>
<li>Create seed data with <code>npm run convert-seed-data</code> - this will take ~10 minutes. Note that this process will fail immediately if the Docker daemon isn't running.</li>
<li>Run the eCR Viewer on <code>localhost:3000/ecr-viewer</code> with <code>npm run local-dev</code>.</li>
</ol>
<h4 id="logging-in" class="tsd-anchor-link">Logging in<a href="#logging-in" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h4><p>The default IDP is keycloak for local development. The default user is <code>ecr-viewer-admin</code> and password is <code>pw</code>.</p>
<h3 id="windows-setup" class="tsd-anchor-link">Windows Setup<a href="#windows-setup" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The eCR Viewer is primailly deveoped on Mac silicon machines, See this <a href="https://github.com/CDCgov/dibbs-ecr-viewer/wiki/Integration-Testing#running-integration-tests-locally-on-windows">integreation testing wiki page</a> for additional infomation for running on Windows machines.</p>
<h3 id="updating-seed-data" class="tsd-anchor-link">Updating Seed Data<a href="#updating-seed-data" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Sample eICRs are included in <code>containers/ecr-viewer/seed-scripts/baseECR/</code>. If you ever need to update the eCRs or add new eCRs you can regenerate the data by:</p>
<ol>
<li>Delete the current volume used by your DB: <code>docker compose -f ./docker-compose.yaml --profile &quot;*&quot; down -v</code></li>
<li>Run <code>npm run convert-seed-data</code> to re-run the FHIR conversion of the seed eCRs</li>
<li>Run <code>npm run local-dev</code> to re-run the eCR Viewer with the newly converted data.</li>
</ol>
<p>By default, the seed data in the <code>LA</code> subfolder converts. To convert other (or additional) subfolders, set the <code>SEED_DATA_DIRECTORIES</code> environment variable to a comma delimited list of subfolders (e.g. <code>LA,Dir2</code> or <code>Dir2</code>).</p>
<h3 id="developer-commands" class="tsd-anchor-link">Developer Commands<a href="#developer-commands" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><p>Additional commands can be found in <a href="media/package.json"><code>package.json</code></a>.</p>
<h3 id="testing" class="tsd-anchor-link">Testing<a href="#testing" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><h4 id="unit-testing" class="tsd-anchor-link">Unit Testing<a href="#unit-testing" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h4><p>Unit tests utilize Jest as the test runner. <a href="https://github.com/nickcolley/jest-axe">Jest-axe</a> provides basic accesibility utilities and <a href="https://testing-library.com/docs/react-testing-library/intro">React testing library</a> provides react utilities.
Running tests:</p>
<ul>
<li><code>npm run test</code> - Run the full suite of unit tests.</li>
<li><code>npm run test:watch</code> - Run tests in <a href="https://jestjs.io/docs/cli#--watch">watch mode</a>. Tests will run that only affect changed code. It will rerun whenever a new change is detected.</li>
</ul>
<h4 id="end-to-end-testing" class="tsd-anchor-link">End to End Testing<a href="#end-to-end-testing" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h4><p>End to end test utilize the Playwright framerwork.
Running Tests:</p>
<ol>
<li>set <code>SEED_DATA_DIRECTORIES=e2e</code> in your <code>.env.local</code>, then <code>npm run convert-seed-data:build</code> to save all required eCRs necessary for e2e tests. The tests require all eCRs located in <code>/seed-scripts/baseECR/e2e</code> have been saved (and no other eCRs).</li>
<li><code>npm run test:e2e</code> to run the tests against <a href="http://localhost:3000/ecr-viewer">http://localhost:3000/ecr-viewer</a>.
<ul>
<li>If the service isn't available, Playwright is <a href="https://playwright.dev/docs/test-webserver">configured to spin it up</a>.</li>
<li>If you would prefer to spin up the service manually, you can run <code>npm run local-dev</code> or <code>npm run local-docker</code>.</li>
</ul>
</li>
</ol>
<p>Other useful playwright tools/commands</p>
<ul>
<li><a href="https://playwright.dev/docs/getting-started-vscode">Playwright VScode extension</a> - Can be used to record tests, run specific tests, and much more!</li>
<li><code>npx playwright show-report</code> - Show the previous test report.</li>
<li><code>npx playwright codegen</code> - <a href="https://playwright.dev/docs/codegen">Record tests</a> using UI.</li>
</ul>
<h2 id="api-documentation" class="tsd-anchor-link">API Documentation<a href="#api-documentation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Can be found in <a href="media/api-documentation.md">api-documentation.md</a>.</p>
<h1 id="architecture-diagram" class="tsd-anchor-link">Architecture Diagram<a href="#architecture-diagram" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h1><p>Note: The diagram omits infrastructure related to OpenTelemetry. OpenTelemetry enables logging and performance tracking; it is omitted for ease of viewing.</p>
<pre><code class="mermaid">flowchart LR

  subgraph requests["Requests"]
    direction TB
    subgraph GET["fas:fa-download <code>GET</code>"]
      hc["<code>/</code>\n(health check)"]
      viewdata["<code>/view-data</code>\n(List View)"]
      detail["<code>/view-data/id</code>\n(Detail View)"]

    end
    subgraph POST["fas:fa-upload <code>POST</code>"]
      ecr["<code>/api/save-fhir-data</code>\n(Save ECR to source)"]
    end
  end


  subgraph service[REST API Service]
    direction TB
    subgraph mr["fab:fa-docker container"]
      viewer["fab:fa-python <code>ecr-viewer<br>HTTP:3000/</code>"]
	  postgres["fab:fa-python <code>postgres<br>HTTP:3000/</code>"]
    end
    subgraph aws["fab:fa-docker AWS"]
      s3["fab:fa-python <code>S3</code>"]
    end
    mr <--> |<br><code>GET /fhir-data</code>| aws
	mr <==> |<code>POST /save-fhir-data</code>| aws

  end

  subgraph response["Responses"]
    subgraph JSON["fa:fa-file-alt <code>JSON</code>"]
      rsp-hc["fa:fa-file-code <code>OK</code> fa:fa-thumbs-up"]
      fhirdata["fa:fa-file-code FHIR Data"]
	  post-ecr["200"]
    end
  end

hc -.-> mr -.-> rsp-hc
viewdata --> mr --> fhirdata
detail --> mr --> fhirdata
ecr ===> mr ===> post-ecr
</code><button type="button">Copy</button></pre>

<h4 id="application-api" class="tsd-anchor-link">Application API<a href="#application-api" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h4><pre><code class="mermaid">graph TD
    A[ecr-viewer]
    subgraph API Endpoints
        direction TB
        M[GET /fhir-data]
        N[POST /save-fhir-data]
    end
    A --> M
    A --> N
    style A fill:#f9f,stroke:#333,stroke-width:4px,color:#000
    style API Endpoints fill:#bfb,stroke:#333,stroke-width:2px
</code><button type="button">Copy</button></pre>

</div></div><div class="col-sidebar"><div class="page-menu"><div class="tsd-navigation settings"><details class="tsd-accordion"><summary class="tsd-accordion-summary"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="assets/icons.svg#icon-chevronDown"></use></svg><h3>Settings</h3></summary><div class="tsd-accordion-details"><div class="tsd-filter-visibility"><span class="settings-label">Member Visibility</span><ul id="tsd-filter-options"><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-protected" name="protected"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Protected</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-inherited" name="inherited" checked/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Inherited</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-external" name="external"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>External</span></label></li></ul></div><div class="tsd-theme-toggle"><label class="settings-label" for="tsd-theme">Theme</label><select id="tsd-theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></div></div></details></div><details open class="tsd-accordion tsd-page-navigation"><summary class="tsd-accordion-summary"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="assets/icons.svg#icon-chevronDown"></use></svg><h3>On This Page</h3></summary><div class="tsd-accordion-details"><a href="#getting-started-with-dibbs-ecr-viewer"><span>Getting <wbr/>Started with DIBBs eCR <wbr/>Viewer</span></a><ul><li><a href="#introduction"><span>Introduction</span></a></li><li><a href="#running-ecr-viewer"><span>Running eCR <wbr/>Viewer</span></a></li><li><ul><li><a href="#running-with-docker-recommended"><span>Running with <wbr/>Docker (<wbr/>Recommended)</span></a></li><li><a href="#running-from-nodejs-source-code"><span>Running from <wbr/>Node.js <wbr/>Source <wbr/>Code</span></a></li></ul></li><li><a href="#building-the-docker-image"><span>Building the <wbr/>Docker <wbr/>Image</span></a></li><li><a href="#non-integrated-viewer"><span>Non <wbr/>Integrated <wbr/>Viewer</span></a></li><li><a href="#potential-issues"><span>Potential <wbr/>Issues</span></a></li><li><a href="#development"><span>Development</span></a></li><li><ul><li><a href="#run-ecr-viewer-locally"><span>Run eCR <wbr/>Viewer <wbr/>Locally</span></a></li><li><ul><li><a href="#logging-in"><span>Logging in</span></a></li></ul></li><li><a href="#windows-setup"><span>Windows <wbr/>Setup</span></a></li><li><a href="#updating-seed-data"><span>Updating <wbr/>Seed <wbr/>Data</span></a></li><li><a href="#developer-commands"><span>Developer <wbr/>Commands</span></a></li><li><a href="#testing"><span>Testing</span></a></li><li><ul><li><a href="#unit-testing"><span>Unit <wbr/>Testing</span></a></li><li><a href="#end-to-end-testing"><span>End to <wbr/>End <wbr/>Testing</span></a></li></ul></li></ul></li><li><a href="#api-documentation"><span>API <wbr/>Documentation</span></a></li></ul><a href="#architecture-diagram"><span>Architecture <wbr/>Diagram</span></a><ul><li><a href="#application-api"><span>Application API</span></a></li></ul></div></details></div><div class="site-menu"><nav class="tsd-navigation"><a href="modules.html">ecr-viewer</a><ul class="tsd-small-nested-navigation" id="tsd-nav-container"><li>Loading...</li></ul></nav></div></div></div><footer><p class="tsd-generator">Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></footer><div class="overlay"></div></body></html>
